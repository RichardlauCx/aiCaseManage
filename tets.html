<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>aiCaseManage Pro - AIç—…ä¾‹ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root {
            --primary: #409eff;
            --success: #67c23a;
            --warning: #e6a23c;
            --danger: #f56c6c;
            --info: #909399;
            --bg: #f4f7fa;
            --card-bg: white;
            --text: #333;
        }
        body.dark {
            --primary: #66b1ff;
            --success: #85ce61;
            --warning: #f3b760;
            --danger: #f78989;
            --info: #a8a8a8;
            --bg: #1e1e1e;
            --card-bg: #2d2d2d;
            --text: #e0e0e0;
        }
        body {
            font-family: "Microsoft YaHei", Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            transition: background 0.3s;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        header {
            background: linear-gradient(135deg, var(--primary), var(--success));
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }
        h1 { margin: 0; font-size: 2.5em; }
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
        }
        .search-bar {
            padding: 20px;
            background: #f9f9f9;
            border-bottom: 1px solid #eee;
        }
        .search-bar input {
            width: 100%;
            max-width: 500px;
            padding: 12px;
            border-radius: 30px;
            border: 1px solid #ddd;
            font-size: 1.1em;
        }
        .patient-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 30px;
        }
        .patient-card {
            background: var(--card-bg);
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
        }
        .patient-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(0,0,0,0.15); }
        .patient-card .progress {
            height: 12px;
            background: #eee;
            border-radius: 6px;
            overflow: hidden;
            margin: 15px 0;
        }
        .patient-card .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--warning), var(--success));
            width: 0%;
            transition: width 0.5s;
        }
        .patient-card .click-hint {
            text-align: right;
            color: var(--primary);
            font-size: 0.9em;
            margin-top: 10px;
        }
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin: 5px;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-location { background: #13ce66; color: white; }
        button:hover { opacity: 0.9; transform: scale(1.05); }
        .section {
            padding: 30px;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 30px;
        }
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            font-weight: bold;
            border-bottom: 4px solid transparent;
        }
        .tab.active {
            border-bottom: 4px solid var(--primary);
            color: var(--primary);
        }
        .task-group {
            background: #f9fbff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e0e8ff;
        }
        .monitor-group {
            background: #e6f7ff;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: center;
        }
        .task-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .task-header label {
            font-size: 1.3em;
            font-weight: bold;
        }
        .status {
            font-size: 1.1em;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 30px;
        }
        .status-complete { background: #e1f3d8; color: var(--success); }
        .status-incomplete { background: #fde2e2; color: var(--danger); }
        .auto-proof {
            font-size: 1em;
            padding: 8px 15px;
            border-radius: 20px;
            background: #fff3cd;
            color: var(--warning);
        }
        .location-info {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        input[type="checkbox"] {
            transform: scale(1.5);
            margin-right: 15px;
        }
        textarea, input[type="text"], input[type="date"], input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #dcdfe6;
            font-family: inherit;
        }
        #monitorStatus {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            min-height: 50px;
            font-weight: bold;
        }
        .completion-dashboard {
            background: linear-gradient(135deg, #f0f9ff, #e6f7ff);
            padding: 30px;
            border-radius: 16px;
            text-align: center;
            margin: 30px 0;
        }
        .progress-circle {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--success) 0% 0%, #eee 0%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px auto;
            font-size: 2em;
            font-weight: bold;
            color: var(--success);
        }
        footer {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 0.9em;
            border-top: 1px solid #eee;
        }
        @media (max-width: 768px) {
            .patient-list { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>aiCaseManage Pro</h1>
            <p>AIè¾…åŠ©ç—…ä¾‹ç®¡ç†ç³»ç»Ÿ Â· å®Œæ•´ç‰ˆï¼ˆæ‰€æœ‰åŠŸèƒ½æ¢å¤ + è‡ªåŠ¨ä½ç½®ç›‘æ§ä¼˜åŒ–ï¼‰</p>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ™ æš—é»‘æ¨¡å¼</button>
        </header>

        <div id="listView">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢ç—…äººå§“åæˆ–ID..." oninput="filterPatients()">
            </div>

            <div class="section">
                <div class="add-patient" style="margin-bottom:30px; text-align:center;">
                    <h2>æ–°å¢ç—…äºº</h2>
                    <input type="text" id="newPatientName" placeholder="ç—…äººå§“åï¼ˆå¿…å¡«ï¼‰">
                    <input type="text" id="newPatientId" placeholder="ç—…äººIDï¼ˆå¯é€‰ï¼‰">
                    <input type="date" id="newPatientDate" placeholder="å…¥é™¢æ—¥æœŸ">
                    <button class="btn-primary" onclick="addPatient()">+ æ·»åŠ ç—…äºº</button>
                </div>

                <h2>ç—…äººåˆ—è¡¨ <span id="patientCount" style="color:var(--info);"></span></h2>
                <div class="patient-list" id="patientList"></div>
            </div>
        </div>

        <div id="patientDetail" style="display:none;">
            <div class="section">
                <button class="btn-danger" onclick="backToList()">â† è¿”å›åˆ—è¡¨</button>
                <button class="btn-danger" onclick="deleteCurrentPatient()" style="margin-left:15px;">ğŸ—‘ï¸ åˆ é™¤ç—…äºº</button>
                <button class="btn-info" onclick="exportPatientData()" style="margin-left:15px;">ğŸ“„ å¯¼å‡ºJSON</button>
                <button class="btn-success" onclick="window.print()" style="margin-left:15px;">ğŸ–¨ï¸ æ‰“å°ç—…ä¾‹</button>

                <h2 style="margin:30px 0;">ç—…äººè¯¦æƒ…ï¼š<span id="currentPatientName"></span> <small>(ID: <span id="currentPatientId"></span>)</small></h2>

                <div class="tabs">
                    <div class="tab active" onclick="showTab('basic')">åŸºæœ¬ä¿¡æ¯</div>
                    <div class="tab" onclick="showTab('tasks')">è¯Šç–—ä»»åŠ¡</div>
                    <div class="tab" onclick="showTab('summary')">å®Œæˆåº¦ä»ªè¡¨ç›˜</div>
                </div>

                <div id="tab-basic">
                    <div class="task-group">
                        <h3>åŸºæœ¬ä¿¡æ¯</h3>
                        <input type="text" id="basicAge" placeholder="å¹´é¾„" onchange="saveData()">
                        <input type="text" id="basicGender" placeholder="æ€§åˆ«ï¼ˆç”·/å¥³/å…¶ä»–ï¼‰" onchange="saveData()">
                        <input type="date" id="basicAdmissionDate" onchange="saveData()">
                        <textarea id="basicDiagnosis" rows="3" placeholder="åˆæ­¥è¯Šæ–­" onchange="saveData()"></textarea>
                        <textarea id="basicHistory" rows="4" placeholder="ç—…å²åŠæ—¢å¾€å²" onchange="saveData()"></textarea>
                    </div>
                </div>

                <div id="tab-tasks" style="display:none;">
                    <div class="monitor-group">
                        <h3>ğŸ“ è‡ªåŠ¨ä½ç½®æ‰“å¡ç›‘æ§ï¼ˆå½±åƒ & ç†ç–—ï¼‰</h3>
                        <button class="btn-success" onclick="startAutoMonitoring()">ğŸš€ å¯åŠ¨è‡ªåŠ¨ç›‘æ§ï¼ˆæŠµè¾¾å³è‡ªåŠ¨å®Œæˆï¼‰</button>
                        <button class="btn-danger" onclick="stopAutoMonitoring()">â¹ï¸ åœæ­¢ç›‘æ§</button>
                        <p style="margin:20px 0; font-size:0.95em;">å¯åŠ¨åç³»ç»Ÿå°†æŒç»­ç›‘æ§ä½ç½®ï¼ˆä»…é¡µé¢æ‰“å¼€æ—¶ï¼‰ï¼Œä¸€æ—¦è¿›å…¥ä»»ä¸€ä»»åŠ¡çš„èŒƒå›´å°†<strong>è‡ªåŠ¨å®Œæˆå¯¹åº”ä»»åŠ¡</strong>ã€‚<br>æ¨èå‰å¾€ç°åœºå‰å¯åŠ¨ï¼Œå¯æœ‰æ•ˆé¿å…å•æ¬¡å®šä½è¶…æ—¶é—®é¢˜ã€‚</p>
                        <div id="monitorStatus">æœªå¯åŠ¨ç›‘æ§</div>
                    </div>

                    <!-- å¼€è¯ -->
                    <div class="task-group">
                        <div class="task-header">
                            <div>
                                <input type="checkbox" id="prescribeDone" onchange="saveData()">
                                <label>å¼€è¯ï¼ˆå¤„æ–¹ï¼‰</label>
                            </div>
                            <span class="status" id="prescribeStatus">æœªå®Œæˆ</span>
                        </div>
                        <input type="date" id="prescribeDate" onchange="saveData()">
                        <textarea id="prescribeDetails" placeholder="è¯å“åç§°ã€å‰‚é‡ã€ç”¨æ³•ã€æ³¨æ„äº‹é¡¹ç­‰" rows="5" onchange="saveData()"></textarea>
                        <textarea id="prescribeResult" placeholder="ç”¨è¯åæƒ…å†µ/æŠ¥å‘Š" rows="3" onchange="saveData()"></textarea>
                    </div>

                    <!-- å½±åƒ -->
                    <div class="task-group">
                        <div class="task-header">
                            <div>
                                <input type="checkbox" id="imagingDone" onchange="saveData()">
                                <label>å½±åƒæ£€æŸ¥ï¼ˆä¸­å¿ƒï¼‰</label>
                            </div>
                            <span class="status" id="imagingStatus">æœªå®Œæˆ</span>
                        </div>
                        <input type="date" id="imagingDate" onchange="saveData()">
                        <textarea id="imagingParts" placeholder="æ£€æŸ¥éƒ¨ä½ï¼ˆå¦‚ï¼šè…°æ¤ã€èƒ¸éƒ¨CTç­‰ï¼‰" rows="2" onchange="saveData()"></textarea>
                        <textarea id="imagingDetails" placeholder="æ£€æŸ¥é¡¹ç›®ã€ä¸´åºŠæŒ‡å¾" rows="4" onchange="saveData()"></textarea>
                        <textarea id="imagingResult" placeholder="å½±åƒæŠ¥å‘Šå®Œæ•´æè¿°" rows="6" onchange="saveData()"></textarea>
                        <input type="text" id="imagingUrl" placeholder="å½±åƒå›¾ç‰‡é“¾æ¥ï¼ˆå¯é€‰ï¼Œè¾“å…¥URLå¯é¢„è§ˆï¼‰" onchange="saveData(); previewImage()">
                        <img id="imagingPreview" style="max-width:100%; border-radius:8px; margin-top:10px; display:none;">

                        <div class="location-info">
                            <h4>ğŸ“ å½±åƒä¸­å¿ƒä½ç½®æ‰“å¡</h4>
                            <input type="text" id="imagingLocationName" placeholder="ä½ç½®åç§°ï¼ˆå¦‚ï¼šXXåŒ»é™¢å½±åƒä¸­å¿ƒï¼‰" onchange="saveData()">
                            <input type="number" step="any" id="imagingLat" placeholder="é¢„æœŸçº¬åº¦ï¼ˆLatitudeï¼‰" onchange="saveData()">
                            <input type="number" step="any" id="imagingLng" placeholder="é¢„æœŸç»åº¦ï¼ˆLongitudeï¼‰" onchange="saveData()">
                            <input type="number" id="imagingRadius" placeholder="å…è®¸åŠå¾„ï¼ˆç±³ï¼Œé»˜è®¤100ï¼‰" value="100" onchange="saveData()">
                            <button class="btn-location" onclick="setCurrentAsExpected('imaging')">ğŸ§­ è®¾ç½®å½“å‰ä½ç½®ä¸ºé¢„æœŸä½ç½®</button>
                            <button class="btn-success" onclick="checkInLocation('imaging')">âœ… æ‰‹åŠ¨æ‰“å¡éªŒè¯</button>
                            <p id="imagingLocationStatus" style="margin-top:10px;"></p>
                        </div>
                    </div>

                    <!-- ç†ç–— -->
                    <div class="task-group">
                        <div class="task-header">
                            <div>
                                <input type="checkbox" id="physioDone" onchange="saveData()">
                                <label>ç†ç–—ï¼ˆç‰©ç†æ²»ç–—ï¼‰</label>
                            </div>
                            <div>
                                <span class="status" id="physioStatus">æœªå®Œæˆ</span>
                                <span class="auto-proof" id="physioProof"></span>
                            </div>
                        </div>
                        <input type="date" id="physioDate" onchange="saveData()">
                        <textarea id="physioPosition" placeholder="æ²»ç–—ä½ç½®æè¿°ï¼ˆå¦‚ï¼šè…°æ¤L4-L5ï¼‰" rows="2" onchange="updateAutoProof()"></textarea>
                        <textarea id="physioDetails" placeholder="æ²»ç–—æ–¹æ¡ˆã€é¢‘ç‡ã€å‚æ•°" rows="4" onchange="saveData()"></textarea>
                        <textarea id="physioResult" placeholder="æ²»ç–—åæ•ˆæœ/æŠ¥å‘Š" rows="3" onchange="saveData()"></textarea>

                        <div class="location-info">
                            <h4>ğŸ“ ç†ç–—ä½ç½®æ‰“å¡</h4>
                            <input type="text" id="physioLocationName" placeholder="ä½ç½®åç§°ï¼ˆå¦‚ï¼šXXåŒ»é™¢ç†ç–—å®¤ï¼‰" onchange="saveData()">
                            <input type="number" step="any" id="physioLat" placeholder="é¢„æœŸçº¬åº¦ï¼ˆLatitudeï¼‰" onchange="saveData()">
                            <input type="number" step="any" id="physioLng" placeholder="é¢„æœŸç»åº¦ï¼ˆLongitudeï¼‰" onchange="saveData()">
                            <input type="number" id="physioRadius" placeholder="å…è®¸åŠå¾„ï¼ˆç±³ï¼Œé»˜è®¤100ï¼‰" value="100" onchange="saveData()">
                            <button class="btn-location" onclick="setCurrentAsExpected('physio')">ğŸ§­ è®¾ç½®å½“å‰ä½ç½®ä¸ºé¢„æœŸä½ç½®</button>
                            <button class="btn-success" onclick="checkInLocation('physio')">âœ… æ‰‹åŠ¨æ‰“å¡éªŒè¯</button>
                            <p id="physioLocationStatus" style="margin-top:10px;"></p>
                            <p style="font-size:0.9em;color:#999;">åŸæ–‡æœ¬è‡ªåŠ¨è¯æ˜é€»è¾‘ä¿ç•™ï¼Œå¯ä½œä¸ºè¾…åŠ©ã€‚</p>
                        </div>
                    </div>
                </div>

                <div id="tab-summary" style="display:none;">
                    <div class="completion-dashboard">
                        <h3>è¯Šç–—å®Œæˆåº¦ä»ªè¡¨ç›˜</h3>
                        <div class="progress-circle" id="progressCircle">0%</div>
                        <p id="completionText" style="font-size:1.3em; margin:20px 0;"></p>
                        <div style="display:flex; justify-content:center; gap:30px; margin-top:30px;">
                            <div><strong>å¼€è¯ï¼š</strong><span id="summaryPrescribe">æœªå®Œæˆ</span></div>
                            <div><strong>å½±åƒï¼š</strong><span id="summaryImaging">æœªå®Œæˆ</span></div>
                            <div><strong>ç†ç–—ï¼š</strong><span id="summaryPhysio">æœªå®Œæˆ</span></div>
                        </div>
                        <div style="margin-top:30px;" id="proofSummary"></div>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            aiCaseManage Pro Â· çº¯å‰ç«¯å®Œæ•´ç‰ˆ<br>
            å·²æ¢å¤æ‰€æœ‰åŠŸèƒ½ Â· è‡ªåŠ¨ä½ç½®ç›‘æ§ä¼˜åŒ–ï¼ˆæŒç»­ç›‘æ§ + è‡ªåŠ¨å®Œæˆï¼‰
        </footer>
    </div>

    <script>
        let patients = JSON.parse(localStorage.getItem('aiCaseManage_pro_patients') || '{}');
        let currentPatientKey = null;
        let watchId = null;

        function getDistance(lat1, lng1, lat2, lng2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getCurrentPosition(callback) {
            if (!navigator.geolocation) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½');
                return;
            }
            navigator.geolocation.getCurrentPosition(
                pos => callback(pos.coords.latitude, pos.coords.longitude),
                err => {
                    let msg = 'å•æ¬¡å®šä½å¤±è´¥ï¼š';
                    if (err.code === 1) msg += 'æƒé™æ‹’ç»';
                    else if (err.code === 2) msg += 'ä½ç½®ä¸å¯ç”¨';
                    else if (err.code === 3) msg += 'è¶…æ—¶ï¼ˆå»ºè®®å¯åŠ¨è‡ªåŠ¨ç›‘æ§ï¼‰';
                    alert(msg);
                },
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 10000 }
            );
        }

        function setCurrentAsExpected(type) {
            getCurrentPosition((lat, lng) => {
                document.getElementById(type + 'Lat').value = lat.toFixed(8);
                document.getElementById(type + 'Lng').value = lng.toFixed(8);
                document.getElementById(type + 'LocationStatus').textContent = `å·²è®¾ç½®å½“å‰ä½ç½®ï¼ˆ${lat.toFixed(8)}, ${lng.toFixed(8)}ï¼‰ä¸ºé¢„æœŸä½ç½®`;
                saveData();
            });
        }

        function checkInLocation(type) {
            const latEl = document.getElementById(type + 'Lat');
            const lngEl = document.getElementById(type + 'Lng');
            const radiusEl = document.getElementById(type + 'Radius');
            const statusEl = document.getElementById(type + 'LocationStatus');

            if (!latEl.value || !lngEl.value) {
                alert('è¯·å…ˆè®¾ç½®é¢„æœŸä½ç½®');
                return;
            }

            const expectedLat = parseFloat(latEl.value);
            const expectedLng = parseFloat(lngEl.value);
            const radius = parseFloat(radiusEl.value) || 100;

            getCurrentPosition((currentLat, currentLng) => {
                const distance = getDistance(currentLat, currentLng, expectedLat, expectedLng);
                if (distance <= radius) {
                    document.getElementById(type + 'Done').checked = true;
                    statusEl.innerHTML = `âœ… æ‰‹åŠ¨æ‰“å¡æˆåŠŸï¼è·ç¦» ${distance.toFixed(1)} ç±³`;
                    statusEl.style.color = 'green';
                    saveData();
                    updateAllStatus();
                    updateCompletionDashboard();
                } else {
                    statusEl.innerHTML = `âŒ æ‰“å¡å¤±è´¥ï¼è·ç¦» ${distance.toFixed(1)} ç±³ï¼ˆ> ${radius} ç±³ï¼‰`;
                    statusEl.style.color = 'red';
                }
            });
        }

        function startAutoMonitoring() {
            if (watchId) {
                document.getElementById('monitorStatus').textContent = 'ç›‘æ§å·²åœ¨è¿è¡Œä¸­';
                return;
            }
            if (!navigator.geolocation) {
                alert('æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®');
                return;
            }

            const p = patients[currentPatientKey];
            const hasTask = (!p.imagingDone && p.imagingLat) || (!p.physioDone && p.physioLat);

            if (!hasTask) {
                document.getElementById('monitorStatus').textContent = 'æ— æœªå®Œæˆçš„ä½ç½®ä»»åŠ¡';
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                pos => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    let html = `ğŸš€ ç›‘æ§ä¸­...<br>å½“å‰ä½ç½®: ${lat.toFixed(8)}, ${lng.toFixed(8)}<br>`;
                    let completed = false;

                    if (!p.imagingDone && p.imagingLat) {
                        const dist = getDistance(lat, lng, parseFloat(p.imagingLat), parseFloat(p.imagingLng));
                        const r = p.imagingRadius || 100;
                        html += `å½±åƒè·ç¦»: ${dist.toFixed(1)}m (â‰¤${r}m)<br>`;
                        if (dist <= r) {
                            document.getElementById('imagingDone').checked = true;
                            document.getElementById('imagingLocationStatus').innerHTML = `âœ… è‡ªåŠ¨å®Œæˆï¼è·ç¦» ${dist.toFixed(1)}m`;
                            html += '<span style="color:green;">âœ… å½±åƒè‡ªåŠ¨å®Œæˆ</span><br>';
                            completed = true;
                        }
                    }

                    if (!p.physioDone && p.physioLat) {
                        const dist = getDistance(lat, lng, parseFloat(p.physioLat), parseFloat(p.physioLng));
                        const r = p.physioRadius || 100;
                        html += `ç†ç–—è·ç¦»: ${dist.toFixed(1)}m (â‰¤${r}m)<br>`;
                        if (dist <= r) {
                            document.getElementById('physioDone').checked = true;
                            document.getElementById('physioLocationStatus').innerHTML = `âœ… è‡ªåŠ¨å®Œæˆï¼è·ç¦» ${dist.toFixed(1)}m`;
                            html += '<span style="color:green;">âœ… ç†ç–—è‡ªåŠ¨å®Œæˆ</span><br>';
                            completed = true;
                        }
                    }

                    document.getElementById('monitorStatus').innerHTML = html;
                    if (completed) {
                        saveData();
                        updateAllStatus();
                        updateCompletionDashboard();
                        if (p.imagingDone && p.physioDone) {
                            stopAutoMonitoring();
                            document.getElementById('monitorStatus').innerHTML += '<br><strong>ğŸ‰ æ‰€æœ‰ä½ç½®ä»»åŠ¡å®Œæˆï¼Œç›‘æ§åœæ­¢</strong>';
                        }
                    }
                },
                err => {
                    let msg = 'å®šä½é”™è¯¯ï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰: ';
                    if (err.code === 3) msg += 'è¶…æ—¶';
                    document.getElementById('monitorStatus').innerHTML = `<span style="color:#e6a23c;">${msg} ç»§ç»­å°è¯•...</span>`;
                },
                { enableHighAccuracy: true, timeout: 30000, maximumAge: 5000 }
            );

            document.getElementById('monitorStatus').textContent = 'ğŸš€ å¯åŠ¨ä¸­...';
        }

        function stopAutoMonitoring() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            document.getElementById('monitorStatus').textContent = 'â¹ï¸ å·²åœæ­¢';
        }

        function toggleTheme() {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        }
        if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

        function renderPatientList() {
            const list = document.getElementById('patientList');
            const search = document.getElementById('searchInput').value.toLowerCase();
            list.innerHTML = '';
            let count = 0;
            for (let key in patients) {
                const p = patients[key];
                if (search && !p.name.toLowerCase().includes(search) && !(p.id || '').toLowerCase().includes(search)) continue;
                count++;
                const doneCount = (p.prescribeDone ? 1 : 0) + (p.imagingDone ? 1 : 0) + (p.physioDone ? 1 : 0);
                const percent = Math.round((doneCount / 3) * 100);

                const card = document.createElement('div');
                card.className = 'patient-card';
                card.onclick = () => selectPatient(key);
                card.innerHTML = `
                    <strong style="font-size:1.4em;">${p.name}</strong><br>
                    <small>ID: ${p.id || 'æ— '} | å…¥é™¢: ${p.basicAdmissionDate || 'æœªå¡«'}</small>
                    <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
                    <p>å®Œæˆåº¦ï¼š${doneCount}/3 (${percent}%)</p>
                    <div class="click-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</div>
                `;
                list.appendChild(card);
            }
            document.getElementById('patientCount').textContent = `ï¼ˆå…± ${count} äººï¼‰`;
            if (count === 0) list.innerHTML = '<p style="grid-column:1/-1; text-align:center; color:#999;">æš‚æ— åŒ¹é…ç—…äºº</p>';
        }

        function filterPatients() { renderPatientList(); }

        function addPatient() {
            const name = document.getElementById('newPatientName').value.trim();
            if (!name) return alert('è¯·è¾“å…¥ç—…äººå§“å');
            const key = Date.now().toString();
            patients[key] = {
                name, id: document.getElementById('newPatientId').value.trim() || null,
                basicAge: '', basicGender: '', basicAdmissionDate: document.getElementById('newPatientDate').value,
                basicDiagnosis: '', basicHistory: '',
                prescribeDone: false, prescribeDate: '', prescribeDetails: '', prescribeResult: '',
                imagingDone: false, imagingDate: '', imagingParts: '', imagingDetails: '', imagingResult: '', imagingUrl: '',
                imagingLocationName: '', imagingLat: '', imagingLng: '', imagingRadius: 100,
                physioDone: false, physioDate: '', physioPosition: '', physioDetails: '', physioResult: '',
                physioLocationName: '', physioLat: '', physioLng: '', physioRadius: 100
            };
            savePatients();
            renderPatientList();
            document.getElementById('newPatientName').value = '';
            document.getElementById('newPatientId').value = '';
            document.getElementById('newPatientDate').value = '';
        }

        function selectPatient(key) {
            stopAutoMonitoring();
            currentPatientKey = key;
            const p = patients[key];
            document.getElementById('currentPatientName').textContent = p.name;
            document.getElementById('currentPatientId').textContent = p.id || 'æ— ';

            document.getElementById('basicAge').value = p.basicAge || '';
            document.getElementById('basicGender').value = p.basicGender || '';
            document.getElementById('basicAdmissionDate').value = p.basicAdmissionDate || '';
            document.getElementById('basicDiagnosis').value = p.basicDiagnosis || '';
            document.getElementById('basicHistory').value = p.basicHistory || '';

            document.getElementById('prescribeDone').checked = p.prescribeDone;
            document.getElementById('prescribeDate').value = p.prescribeDate || '';
            document.getElementById('prescribeDetails').value = p.prescribeDetails || '';
            document.getElementById('prescribeResult').value = p.prescribeResult || '';

            document.getElementById('imagingDone').checked = p.imagingDone;
            document.getElementById('imagingDate').value = p.imagingDate || '';
            document.getElementById('imagingParts').value = p.imagingParts || '';
            document.getElementById('imagingDetails').value = p.imagingDetails || '';
            document.getElementById('imagingResult').value = p.imagingResult || '';
            document.getElementById('imagingUrl').value = p.imagingUrl || '';
            document.getElementById('imagingLocationName').value = p.imagingLocationName || '';
            document.getElementById('imagingLat').value = p.imagingLat || '';
            document.getElementById('imagingLng').value = p.imagingLng || '';
            document.getElementById('imagingRadius').value = p.imagingRadius || 100;
            document.getElementById('imagingLocationStatus').textContent = '';

            document.getElementById('physioDone').checked = p.physioDone;
            document.getElementById('physioDate').value = p.physioDate || '';
            document.getElementById('physioPosition').value = p.physioPosition || '';
            document.getElementById('physioDetails').value = p.physioDetails || '';
            document.getElementById('physioResult').value = p.physioResult || '';
            document.getElementById('physioLocationName').value = p.physioLocationName || '';
            document.getElementById('physioLat').value = p.physioLat || '';
            document.getElementById('physioLng').value = p.physioLng || '';
            document.getElementById('physioRadius').value = p.physioRadius || 100;
            document.getElementById('physioLocationStatus').textContent = '';

            previewImage();
            updateAllStatus();
            updateCompletionDashboard();
            showTab('basic');
            document.getElementById('listView').style.display = 'none';
            document.getElementById('patientDetail').style.display = 'block';

            const hasUnfinished = (!p.imagingDone && p.imagingLat && p.imagingLng) || (!p.physioDone && p.physioLat && p.physioLng);
            if (hasUnfinished) {
                setTimeout(() => {
                    if (confirm('æ£€æµ‹åˆ°æœªå®Œæˆçš„ä½ç½®ä»»åŠ¡ä¸”å·²è®¾ç½®é¢„æœŸä½ç½®\næ˜¯å¦ç«‹å³å¯åŠ¨è‡ªåŠ¨ç›‘æ§ï¼Ÿï¼ˆæ¨èå¼€å¯ï¼ŒæŠµè¾¾å³è‡ªåŠ¨å®Œæˆï¼‰')) {
                        showTab('tasks');
                        startAutoMonitoring();
                    }
                }, 500);
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('#patientDetail > .section > div[id^="tab-"]').forEach(el => el.style.display = 'none');
            document.getElementById('tab-' + tabName).style.display = 'block';
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            if (tabName === 'summary') updateCompletionDashboard();
        }

        function backToList() {
            stopAutoMonitoring();
            currentPatientKey = null;
            document.getElementById('patientDetail').style.display = 'none';
            document.getElementById('listView').style.display = 'block';
            renderPatientList();
        }

        function deleteCurrentPatient() {
            if (confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤è¯¥ç—…äººæ‰€æœ‰è®°å½•ï¼Ÿ')) {
                delete patients[currentPatientKey];
                savePatients();
                backToList();
            }
        }

        function exportPatientData() {
            const data = patients[currentPatientKey];
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç—…äºº_${data.name}_${data.id || 'æœªçŸ¥'}.json`;
            a.click();
        }

        function previewImage() {
            const url = document.getElementById('imagingUrl').value.trim();
            const img = document.getElementById('imagingPreview');
            if (url) {
                img.src = url;
                img.style.display = 'block';
            } else {
                img.style.display = 'none';
            }
        }

        function saveData() {
            if (!currentPatientKey) return;
            const p = patients[currentPatientKey];
            p.basicAge = document.getElementById('basicAge').value;
            p.basicGender = document.getElementById('basicGender').value;
            p.basicAdmissionDate = document.getElementById('basicAdmissionDate').value;
            p.basicDiagnosis = document.getElementById('basicDiagnosis').value;
            p.basicHistory = document.getElementById('basicHistory').value;

            p.prescribeDone = document.getElementById('prescribeDone').checked;
            p.prescribeDate = document.getElementById('prescribeDate').value;
            p.prescribeDetails = document.getElementById('prescribeDetails').value;
            p.prescribeResult = document.getElementById('prescribeResult').value;

            p.imagingDone = document.getElementById('imagingDone').checked;
            p.imagingDate = document.getElementById('imagingDate').value;
            p.imagingParts = document.getElementById('imagingParts').value;
            p.imagingDetails = document.getElementById('imagingDetails').value;
            p.imagingResult = document.getElementById('imagingResult').value;
            p.imagingUrl = document.getElementById('imagingUrl').value;
            p.imagingLocationName = document.getElementById('imagingLocationName').value;
            p.imagingLat = document.getElementById('imagingLat').value;
            p.imagingLng = document.getElementById('imagingLng').value;
            p.imagingRadius = document.getElementById('imagingRadius').value || 100;

            p.physioDone = document.getElementById('physioDone').checked;
            p.physioDate = document.getElementById('physioDate').value;
            p.physioPosition = document.getElementById('physioPosition').value;
            p.physioDetails = document.getElementById('physioDetails').value;
            p.physioResult = document.getElementById('physioResult').value;
            p.physioLocationName = document.getElementById('physioLocationName').value;
            p.physioLat = document.getElementById('physioLat').value;
            p.physioLng = document.getElementById('physioLng').value;
            p.physioRadius = document.getElementById('physioRadius').value || 100;

            savePatients();
            updateAllStatus();
            renderPatientList();
        }

        function updateAutoProof() {
            const imagingParts = (document.getElementById('imagingParts').value || '').toLowerCase();
            const physioPosition = (document.getElementById('physioPosition').value || '').toLowerCase();
            const proof = document.getElementById('physioProof');
            let message = '';
            if (physioPosition.includes('é‡åˆ') || physioPosition.includes('åˆé€‚') || physioPosition.includes('åŒ¹é…')) {
                message = 'âœ“ æ–‡æœ¬å«å…³é”®è¯ï¼Œè¾…åŠ©è¯æ˜';
            } else if (imagingParts && physioPosition && (physioPosition.includes(imagingParts) || imagingParts.includes(physioPosition))) {
                message = 'âœ“ æ–‡æœ¬éƒ¨ä½åŒ¹é…ï¼Œè¾…åŠ©è¯æ˜';
            }
            proof.innerHTML = message;
            updateCompletionDashboard();
        }

        function updateAllStatus() {
            updateStatus('prescribe', document.getElementById('prescribeDone').checked);
            updateStatus('imaging', document.getElementById('imagingDone').checked);
            updateStatus('physio', document.getElementById('physioDone').checked);
            updateAutoProof();
        }

        function updateStatus(prefix, done) {
            const el = document.getElementById(prefix + 'Status');
            el.textContent = done ? 'å·²å®Œæˆ' : 'æœªå®Œæˆ';
            el.className = 'status ' + (done ? 'status-complete' : 'status-incomplete');
        }

        function updateCompletionDashboard() {
            if (!currentPatientKey) return;
            const p = patients[currentPatientKey];
            const doneCount = (p.prescribeDone ? 1 : 0) + (p.imagingDone ? 1 : 0) + (p.physioDone ? 1 : 0);
            const percent = Math.round((doneCount / 3) * 100);

            document.getElementById('progressCircle').style.background = `conic-gradient(var(--success) ${percent}%, #eee ${percent}%)`;
            document.getElementById('progressCircle').textContent = `${percent}%`;

            document.getElementById('completionText').textContent = doneCount === 3 ? 'ğŸ‰ å…¨éƒ¨ä¸‰é¡¹ä»»åŠ¡å·²å®Œæˆï¼ç—…ä¾‹å¯ç»“æ¡ˆ' : `å·²å®Œæˆ ${doneCount}/3 é¡¹æ ¸å¿ƒä»»åŠ¡`;

            document.getElementById('summaryPrescribe').textContent = p.prescribeDone ? 'âœ… å·²å®Œæˆ' : 'âŒ æœªå®Œæˆ';
            document.getElementById('summaryImaging').textContent = p.imagingDone ? 'âœ… å·²å®Œæˆ' : 'âŒ æœªå®Œæˆ';
            document.getElementById('summaryPhysio').textContent = p.physioDone ? 'âœ… å·²å®Œæˆ' : 'âŒ æœªå®Œæˆ';

            let proofHTML = '';
            if (document.getElementById('physioProof').innerHTML) proofHTML += '<p style="color:var(--success);">âœ… æ–‡æœ¬è¾…åŠ©è¯æ˜é€šè¿‡</p>';
            if (p.imagingDone && p.physioDone) proofHTML += '<p style="color:var(--success);font-weight:bold;">âœ… å½±åƒä¸ç†ç–—ä½ç½®æ‰“å¡å‡å®Œæˆ</p>';
            document.getElementById('proofSummary').innerHTML = proofHTML;
        }

        function savePatients() {
            localStorage.setItem('aiCaseManage_pro_patients', JSON.stringify(patients));
        }

        renderPatientList();
    </script>
</body>
</html>